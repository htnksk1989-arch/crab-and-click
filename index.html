<!doctype html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0e" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta property="og:title" content="CRAB SOULSï¼šSin of the Shell" />
  <meta property="og:description" content="10ç§’è¨˜æ†¶ã€å³å®Ÿè·µã€‚ãŸã ã²ãŸã™ã‚‰ã«ã€ã‚«ãƒ‹ã‚’å‰¥ã‘ã€‚" />
  <meta property="og:type" content="website" />

  <title>CRAB SOULS</title>
  <style>
    :root{
      --bg:#0c0c0e;
      --panel:rgba(20, 18, 16, 0.95);
      --text:#e6e6e6;
      --muted:#9a8f82;
      --accent:#ff8c00;
      --danger:#ff4d4d;
      --blood:#8a0b0b;
      --gold:#ffd700;
    }

    body{
      margin:0;
      font-family: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", serif;
      background: radial-gradient(circle at 50% -20%, #2a2018, var(--bg) 60%);
      color:var(--text);
      height: 100dvh;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    .wrap{
      width:100%;
      height:100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* =========================================
       ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
    ========================================= */
    #startScreen {
      width: min(600px, 90vw);
      padding: 30px 20px;
      background: var(--panel);
      border: 1px solid rgba(255, 140, 0, 0.2);
      border-radius: 12px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      text-align: center;
      backdrop-filter: blur(20px);
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.8s ease-out;
    }

    .title-image-container {
        width: 100%;
        height: 40dvh; 
        min-height: 250px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border: 1px solid rgba(255, 140, 0, 0.1);
        background: #000;
        position: relative;
    }
    
    .title-main-art {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center top;
        display: block;
    }
    .title-main-art:after {
        content: "CRAB SOULS";
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: #1a120a;
        display: flex; align-items: center; justify-content: center;
        color: var(--accent); font-size: 24px; font-weight: bold;
    }

    .game-subtitle {
        margin: -5px 0 5px 0;
        font-size: 16px;
        color: var(--accent);
        font-weight: bold;
        letter-spacing: 0.2em;
        text-shadow: 0 2px 10px rgba(255, 70, 0, 0.4);
        opacity: 0.9;
    }

    .rule-box {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255, 140, 0, 0.15);
      border-radius: 8px;
      padding: 20px;
      text-align: left;
    }
    .rule-box h2 { margin: 0 0 12px 0; font-size: 16px; color: var(--accent); }
    .rule-box p { margin: 0 0 8px 0; font-size: 14px; line-height: 1.6; color: var(--muted); }
    .rule-box strong { color: var(--text); font-weight: 700; }

    .start-buttons {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }

    /* =========================================
       ã‚²ãƒ¼ãƒ ç”»é¢
    ========================================= */
    #gameScreen {
      display: none;
      width:min(980px, 94vw);
      height: min(800px, 96dvh);
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
      animation: fadeIn 0.5s ease-out;
    }
    #gameScreen.active { display: grid; }

    @media (max-width: 820px){
      #gameScreen{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: 100dvh;
        gap: 10px;
        padding: 10px;
        padding-top: max(10px, env(safe-area-inset-top));
        padding-bottom: max(10px, env(safe-area-inset-bottom));
      }
    }

    .side{
      background: var(--panel);
      border:1px solid rgba(255, 255, 255, 0.05);
      border-radius:16px;
      padding:16px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }
    .side-header {
        display: flex; align-items: center; justify-content: center; margin-bottom: 16px;
    }
    .mini-title { font-size: 20px; font-weight: bold; margin: 0; color: var(--accent); letter-spacing: 0.05em; }
    
    @media (max-width: 820px){
      .side{
        padding: 8px 12px;
        flex-direction: row;
        align-items: center;
        gap: 12px;
        min-height: auto;
      }
      .side-header { margin-bottom: 0; flex: 0 0 auto; }
      .mini-title { font-size: 16px; }
      .stat { margin-top: 0 !important; padding-top: 0 !important; border: none !important; flex: 1; }
      .card { padding: 4px 8px; }
      .label { font-size: 8px; }
      .value { font-size: 14px; }
    }

    .btn{
      width:100%; appearance:none; border:1px solid rgba(255, 140, 0, 0.3);
      background: linear-gradient(180deg, #2a2018, #1a120a);
      color:var(--text); padding:14px; border-radius:8px;
      font-weight:700; font-size: 14px; cursor:pointer; touch-action: manipulation;
      transition: transform 0.1s, opacity 0.1s, box-shadow 0.2s;
      font-family: serif;
      text-decoration: none; display: inline-block; box-sizing: border-box;
      text-align: center;
    }
    .btn:active{ transform: scale(0.96); opacity: 0.9; }
    .btn.primary {
      border-color: var(--accent);
      background: linear-gradient(180deg, #3d2e1e, #2a2015);
      box-shadow: 0 4px 15px rgba(255, 140, 0, 0.2);
      font-size: 16px;
      color: var(--accent);
    }
    .btn.primary:hover { box-shadow: 0 4px 25px rgba(255, 140, 0, 0.4); }
    .btn.secondary{ background: transparent; border-color: rgba(255,255,255,0.1); color: var(--muted); }
    
    /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ç”¨ã®ç‰¹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn.reward {
        background: linear-gradient(180deg, #2a2018, #000);
        border: 1px solid var(--accent);
        color: var(--accent);
        margin-top: 15px;
        font-size: 13px;
        padding: 10px;
    }

    .stat{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:auto; }
    @media (min-width: 821px) { .stat { grid-template-columns: 1fr 1fr; } }

    .card{ background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.05); border-radius:8px; padding:8px 10px; text-align: center;}
    .label{ font-size:9px; color:var(--muted); text-transform: uppercase; }
    .value{ font-size:16px; font-weight:700; font-variant-numeric: tabular-nums; }

    .main{
      background: var(--panel);
      border:1px solid rgba(255, 255, 255, 0.05);
      border-radius:16px;
      position:relative;
      overflow:hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .board{
      position:relative; width: 100%; height: 100%; touch-action: none;
    }

    .piece{
      position:absolute; width: 96px; height: 72px; border-radius:8px;
      background: linear-gradient(135deg, #2c241b, #1a1510);
      border:1px solid rgba(150, 120, 100, 0.3);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10; transform: translate3d(0,0,0); transition: transform 0.1s;
    }
    @media (max-width: 600px){ .piece { width: 80px; height: 60px; border-radius: 6px; } }
    .piece:active{ transform: scale(0.92) translate3d(0,0,0); }
    
    .crab-img { width: 40px; height: 40px; object-fit: contain; pointer-events: none; filter: sepia(0.4) contrast(1.2); }
    .crab-fallback { font-size: 32px; line-height: 1; display: none; pointer-events: none; }
    .img-error .crab-img { display: none; }
    .img-error .crab-fallback { display: block; }

    .num{
      font-size:24px; font-weight:900; color:var(--accent); margin-left:2px;
      text-shadow: 0 0 10px rgba(255, 140, 0, 0.5); position: relative; z-index: 2; pointer-events: none;
      font-family: serif;
    }
    .hidden .num{ opacity: 0; }

    .ok{ border-color: var(--accent) !important; background: rgba(255, 140, 0, 0.15); opacity: 0.6; pointer-events: none; }
    .bad{ border-color: var(--danger) !important; background: rgba(255, 107, 107, 0.2); animation: shake .2s linear 2; }
    @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®èª¿æ•´ */
    .overlay{
      position:absolute; inset:0;
      background: rgba(10, 12, 18, 0.6);
      display:flex; flex-direction: column; align-items:center; justify-content:center;
      text-align:center; padding:20px; z-index: 100; transition: opacity 0.3s;
      text-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
    /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .overlay.gameover {
        background: rgba(30, 0, 0, 0.85);
        border: 2px solid var(--blood);
    }
    .overlay.gameover h2 {
        color: var(--danger) !important;
        font-size: 32px;
        letter-spacing: 0.1em;
        text-shadow: 0 0 20px var(--blood);
        margin: 0 0 16px 0;
    }
    .overlay.gameover p { color: #ffaaaa !important; margin: 0 0 20px 0; font-size: 14px; line-height: 1.6;}

    /* å®Œå…¨å‹åˆ©æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .overlay.victory {
        background: rgba(10, 5, 0, 0.95);
        border: 2px solid var(--gold);
        box-shadow: inset 0 0 50px rgba(255, 215, 0, 0.1);
    }
    .overlay.victory h2 {
        color: var(--gold) !important;
        font-size: 32px;
        letter-spacing: 0.15em;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        margin: 0 0 16px 0;
        font-family: serif;
    }
    .overlay.victory p {
        color: #fff8e0 !important;
        font-size: 14px;
        line-height: 1.8;
        margin: 0 0 20px 0;
        opacity: 0.9;
    }
    
    .overlay.fadeout { opacity: 0; pointer-events: none; }

    #manualStartBtn {
        margin-top: 24px;
        padding: 10px 30px;
        border: 1px solid var(--accent);
        background: rgba(255, 140, 0, 0.2);
        color: var(--accent);
        border-radius: 4px;
        font-family: serif;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #manualStartBtn:active { transform: scale(0.95); background: rgba(255, 140, 0, 0.3); }
    
    #backToStartBtn {
        position: absolute; top: 12px; left: 12px; z-index: 200;
        padding: 6px 14px; font-size: 12px; border-radius: 4px;
        background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.2);
        color: var(--muted); cursor: pointer; font-family: serif;
        backdrop-filter: blur(4px);
        transition: opacity 0.2s;
    }
    #backToStartBtn:hover { opacity: 0.8; background: rgba(50,40,30,0.9); }

    .overlay-back-btn {
        margin-top:20px; padding:12px 24px; border-radius:4px; font-family:serif; font-weight:bold; cursor:pointer;
    }

    .toast{
      position:absolute; bottom:30px; left:50%; transform: translateX(-50%) translateY(20px);
      background:rgba(25, 20, 15, 0.95); border:1px solid rgba(150, 120, 100, 0.3);
      border-radius:4px; padding:10px 24px;
      font-size:14px; color:var(--accent); white-space: nowrap;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); font-family: serif;
      z-index: 200; pointer-events: none; opacity: 0;
      transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast strong { color: #fff; }
  </style>
</head>
<body>
  <audio id="bgm-title" loop preload="auto">
    <source src="bgm_title.mp3" type="audio/mpeg">
  </audio>
  <audio id="bgm-game" loop preload="auto">
    <source src="bgm_game.mp3" type="audio/mpeg">
  </audio>

  <div class="wrap">
    <section id="startScreen">
      <div class="title-image-container">
          <img src="title.png" alt="CRAB SOULS Title Art" class="title-main-art" onerror="this.style.display='none'">
      </div>
      <p class="game-subtitle">Sin of the Shell</p>
      <div class="rule-box">
        <h2>ğŸ“œ èª“ç´„ </h2>
        <p>1. é–‹å§‹å¾Œã€ç•ªå·ãŒé–‹ç¤ºã•ã‚Œã‚‹ã€‚</p>
        <p>2. ç•ªå·æ¶ˆå¤±å¾Œã€<strong>1ã‹ã‚‰é †ã«</strong>æ®»ã‚’å‰¥ã‘ã€‚</p>
        <p>3. <strong>ä¸€åº¦ã®éã¡ã§å³åº§ã«æ­»</strong>ã¨ãªã‚‹ã€‚</p>
        <p style="margin-top:12px; font-size:12px; opacity:0.7; line-height: 1.8;">
            â€»æœ¬ç•ªï¼š10ç§’å¼·åˆ¶é–‹å§‹<br>
            ã€€æ•—åŒ—æ¡ä»¶ï¼š<strong>ç´¯è¨ˆ5æ­»</strong><br>
            ã€€å‹åˆ©æ¡ä»¶ï¼š<strong>ç´¯è¨ˆ3ã‚¯ãƒªã‚¢</strong><br>
            â€»ç·´ç¿’ï¼šç„¡åˆ¶é™ (æ‰‹å‹•é–‹å§‹)
        </p>
      </div>
      <div class="start-buttons">
        <button class="btn primary" id="startHardBtn">èª“ç´„ã‚’çµã¶ (æœ¬ç•ª)</button>
        <button class="btn secondary" id="startPracticeBtn">ä»®èª“ç´„ (ç·´ç¿’)</button>
      </div>
    </section>

    <div id="gameScreen">
      <section class="side">
        <div class="side-header">
            <h2 class="mini-title">ğŸ¦€ CRAB SOULS</h2>
        </div>
        <div class="stat">
          <div class="card">
            <div class="label">Victory</div>
            <div class="value" id="streak">0</div>
          </div>
          <div class="card">
            <div class="label">Death</div>
            <div class="value" id="deaths">0</div>
          </div>
        </div>
      </section>
      <section class="main">
        <button id="backToStartBtn">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>

        <div class="board hidden" id="board"></div>
        <div class="overlay" id="overlay">
          
          <div id="memoContent">
              <h2 style="color:var(--accent); margin-bottom:10px; font-family: serif;">è¨˜æ†¶ã›ã‚ˆã€‚</h2>
              <p style="font-size:14px; color:#e6e6e6;">
                æ®‹ã‚Š <span id="memoTimer" style="font-weight:bold; font-size:24px; color:var(--accent);"></span>
              </p>
              <button id="manualStartBtn">è¨˜æ†¶ã—ãŸ (é–‹å§‹)</button>
              <p style="font-size:12px; color:#889; margin-top:20px; font-family: serif;">
                  æ™‚ãŒæ¥ã‚Œã°ã€çœŸå®Ÿã¯é—‡ã«è¦†ã‚ã‚Œã‚‹ã€‚
              </p>
          </div>

          <div id="resultContent" style="display:none;"></div>

        </div>
        <div class="toast" id="toast"></div>
      </section>
    </div>
  </div>

<script>
(() => {
  // ====== Config ======
  const PIECES = 9;
  const MEMO_SEC = 10;
  const MAX_TOTAL_DEATHS = 5; 
  const REQUIRED_TOTAL_CLEARS = 3;
  
  const CRAB_IMAGES = [
    "crab1.png", "crab2.png", "crab3.png",
    "crab4.png", "crab5.png", "crab6.png", 
    "crab7.png", "crab8.png", "crab9.png"
  ];

  // ====== State ======
  let order = [];
  let nextIndex = 0;
  let streak = 0;
  let totalDeaths = 0;
  let totalClears = 0;
  let mode = "-";
  let isLocked = false;
  let timerInterval = null;

  // ====== UI Refs ======
  const startScreen = document.getElementById("startScreen");
  const gameScreen = document.getElementById("gameScreen");
  const board = document.getElementById("board");
  const overlay = document.getElementById("overlay");
  const memoContent = document.getElementById("memoContent");
  const resultContent = document.getElementById("resultContent");
  const memoTimerDisp = document.getElementById("memoTimer");
  const manualStartBtn = document.getElementById("manualStartBtn");

  const toast = document.getElementById("toast");
  const backToStartBtn = document.getElementById("backToStartBtn");

  const bgmTitle = document.getElementById("bgm-title");
  const bgmGame = document.getElementById("bgm-game");
  bgmTitle.volume = 0.3;
  bgmGame.volume = 0.4;

  const els = {
    deaths: document.getElementById("deaths"),
    streak: document.getElementById("streak"),
  };

  // ====== Messages ======
  const msg = {
    success: ["	â€¦ã»ã†", "â€¦ã¾ã ã¾ã ", "â€¦ãµã‚“"],
    fail: ["ãŠã‚„ãŠã‚„ãŠã‚„â€¥", "çŸ¥ã‚Šå¾—ãŸã‹ï¼Ÿã‚«ãƒ‹ã®åˆƒã®åˆ‡ã‚Œå‘³ã‚’", "æ„šã‹ãªé‡å¿ƒã¯å¿˜ã‚Œã‚‹ã“ã¨ã ãª"],
    clear: ["Victory Achieved", "You Defeated", "Great Enemy Felled"]
  };

  // ====== Functions ======

  function stopAudio(audioEl) {
    audioEl.pause();
    audioEl.currentTime = 0;
  }
  function playAudio(audioEl) {
    audioEl.play().catch(e => console.log("BGMå†ç”Ÿå¾…æ©Ÿ:", e));
  }

  function switchToTitleBgm() {
    stopAudio(bgmGame);
    playAudio(bgmTitle);
  }
  function switchToGameBgm() {
    stopAudio(bgmTitle);
    playAudio(bgmGame);
  }

  function pulse(pattern = 10) {
    if (typeof navigator !== 'undefined' && navigator.vibrate) navigator.vibrate(pattern);
  }
  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
  function showToast(html, duration = 1500){
    toast.innerHTML = html; toast.classList.add("show");
    clearTimeout(showToast.timer);
    showToast.timer = setTimeout(() => toast.classList.remove("show"), duration);
  }
  
  function updateStats(){
    els.deaths.textContent = totalDeaths;
    els.streak.textContent = streak;
  }

  function showGameScreen() {
      startScreen.style.display = 'none';
      gameScreen.classList.add('active');
  }
  function showStartScreen() {
      gameScreen.classList.remove('active');
      startScreen.style.display = 'flex';
      clearInterval(timerInterval);
      switchToTitleBgm();
  }

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢
  function showGameOver() {
    stopAudio(bgmGame);
    pulse([200, 100, 200, 100, 500]);
    
    overlay.classList.add("gameover");
    overlay.classList.remove("fadeout");
    overlay.style.display = 'flex';
    backToStartBtn.style.display = 'none';
    memoContent.style.display = 'none';
    resultContent.style.display = 'block';

    resultContent.innerHTML = `
        <h2>YOU DIED</h2>
        <p>â€¦åŒå¿—ã‚ˆã€‚ã“ã‚Œã¾ã§å›ã¯ã€ã‚ˆãæˆ¦ã£ãŸ</p>
        <button class="overlay-back-btn" style="background:#8a0b0b; color:#fff; border:1px solid #ff4d4d;" onclick="resetToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
    `;
  }

// å®Œå…¨å‹åˆ©ç”»é¢
  function showVictory() {
    // stopAudio(bgmGame);  <-- ä¿®æ­£å‰: ã“ã“ã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—...
    switchToTitleBgm();  // <-- ä¿®æ­£å¾Œ: ã“ã‚Œã«ç½®ãæ›ãˆã¾ã™ã€‚ã“ã‚Œã§ã‚¿ã‚¤ãƒˆãƒ«BGMãŒæµã‚Œã¾ã™ã€‚
    
    pulse([100, 50, 100, 50, 100, 50, 500]);
    
    overlay.classList.add("victory");
    overlay.classList.remove("fadeout");
    overlay.style.display = 'flex';
    backToStartBtn.style.display = 'none';
    memoContent.style.display = 'none';
    resultContent.style.display = 'block';
    resultContent.innerHTML = `
        <h2>PLEDGE FULFILLED</h2>
        <p>â€¦è²´å…¬ã€ãã®åŠ›â€¦ç‹ã®ã€å™¨ã‹â€¦<br>ã™ã¿ã¾ã›ã‚“ã€ã‚«ãƒ‹ã¯æ•—ã‚Œã¾ã—ãŸâ€¦</p>
        <a href="victory.png" download="victory_reward.png" class="btn reward">
           ğŸ¦€ å ±é…¬ã‚¢ã‚¤ãƒ†ãƒ  (Download)
        </a>

        <div style="margin-top:10px;">
           <button class="overlay-back-btn" style="background:transparent; border:1px solid rgba(255,255,255,0.3); color:#ccc;" onclick="resetToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    `;
  }

  window.resetToTitle = () => {
      overlay.classList.remove("gameover", "victory", "fadeout");
      overlay.style.display = 'none';
      totalDeaths = 0;
      totalClears = 0;
      streak = 0;
      updateStats();
      showStartScreen();
  };


  function setupBoard(){
    board.innerHTML = ""; board.classList.remove("hidden");
    const w = board.clientWidth; const h = board.clientHeight;
    const isMobile = w < 600;
    const pW = isMobile ? 80 : 96; const pH = isMobile ? 60 : 72;
    const cols = 3; const rows = 3;
    const cellW = w / cols; const cellH = h / rows;

    order = Array.from({length: PIECES}, (_, i) => i);
    for(let i = order.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [order[i], order[j]] = [order[j], order[i]];
    }

    for(let i = 0; i < PIECES; i++){
      const piece = document.createElement("div");
      piece.className = "piece"; piece.dataset.id = i;
      const imgSrc = CRAB_IMAGES[i % CRAB_IMAGES.length];
      piece.innerHTML = `
        <img src="${imgSrc}" class="crab-img" onerror="this.parentElement.classList.add('img-error')" alt="crab">
        <span class="crab-fallback">ğŸ¦€</span>
        <span class="num">${order.indexOf(i) + 1}</span>
      `;
      const c = i % cols; const r = Math.floor(i / cols);
      const jitterX = (Math.random() - 0.5) * (cellW * 0.3);
      const jitterY = (Math.random() - 0.5) * (cellH * 0.3);
      const x = (c * cellW) + (cellW - pW)/2 + jitterX;
      const y = (r * cellH) + (cellH - pH)/2 + jitterY;
      const safeX = Math.max(8, Math.min(w - pW - 8, x));
      const safeY = Math.max(8, Math.min(h - pH - 8, y));
      piece.style.left = `${safeX}px`; piece.style.top = `${safeY}px`;
      piece.onpointerdown = (e) => { e.stopPropagation(); handlePieceClick(piece); };
      board.appendChild(piece);
    }
  }

  function handlePieceClick(piece){
    if(isLocked || piece.classList.contains("ok")) return;
    checkAnswer(piece);
  }

  function checkAnswer(piece){
    const id = parseInt(piece.dataset.id);
    const expected = order[nextIndex];
    if(id === expected){
      // æ­£è§£
      pulse(8); piece.classList.add("ok"); 
      nextIndex++; 
      
      if(nextIndex >= PIECES){
        // å…¨ã‚«ãƒ‹å‰¥ãå®Œäº†ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ã‚¯ãƒªã‚¢ï¼‰
        streak++; 
        totalClears++;
        updateStats();

        if(mode === "HARD" && totalClears >= REQUIRED_TOTAL_CLEARS){
            showVictory();
        } else {
            pulse([50, 50, 50]);
            let clearMsg = pick(msg.clear);
            if(mode === "HARD") clearMsg += ` (ç´¯è¨ˆã‚¯ãƒªã‚¢: ${totalClears})`;
            showToast(clearMsg, 3000);
            endGame(true);
        }
      } else {
        if(mode === "HARD" && nextIndex > 0 && nextIndex % 3 === 0) showToast(pick(msg.success), 800);
      }
    } else {
      // ä¸æ­£è§£
      pulse(100); piece.classList.add("bad"); 
      // streak = 0; // â˜…ä¿®æ­£: ãƒŸã‚¹ã—ã¦ã‚‚ã‚¯ãƒªã‚¢æ•°ã¯ç¶­æŒã™ã‚‹
      updateStats();

      if(mode === "HARD") {
          totalDeaths++;
          updateStats();
          if(totalDeaths >= MAX_TOTAL_DEATHS) {
              showGameOver();
              return;
          }
      }
      showToast(pick(msg.fail), 2500); endGame(false);
    }
  }

  function endGame(cleared){
    isLocked = true;
    setTimeout(() => { startGame(); }, cleared ? 2500 : 2000);
  }

  function setupMemoScreen(timeLeftText, showManualBtn) {
    overlay.classList.remove("fadeout", "gameover", "victory");
    overlay.style.display = 'flex';
    backToStartBtn.style.display = 'block';
    
    memoContent.style.display = 'block';
    resultContent.style.display = 'none';

    memoTimerDisp.textContent = timeLeftText;
    manualStartBtn.style.display = showManualBtn ? 'block' : 'none';
  }

  function startGame(selectedMode){
    switchToGameBgm();
    if(selectedMode) mode = selectedMode;
    
    nextIndex = 0;
    isLocked = true;
    updateStats();
    showGameScreen();
    setupBoard();
    
    if(timerInterval) clearInterval(timerInterval);

    if (mode === "PRACTICE") {
        setupMemoScreen("âˆ", true);
    } else {
        let timeLeft = MEMO_SEC;
        setupMemoScreen(timeLeft + " ç§’", false);

        timerInterval = setInterval(() => {
            timeLeft--;
            memoTimerDisp.textContent = timeLeft + " ç§’";
            if(timeLeft <= 0){
                clearInterval(timerInterval);
                finishMemorize();
            }
        }, 1000);
    }
  }

  function finishMemorize(){
    board.classList.add("hidden");
    overlay.classList.add("fadeout");
    setTimeout(() => {
        if(overlay.classList.contains('fadeout')) {
            overlay.style.display = 'none';
        }
    }, 300);
    isLocked = false;
    pulse(20);
    showToast("å§‹ã‚ã‚ˆã€‚", 1000);
  }

  // ====== Event Listeners ======
  document.getElementById("startHardBtn").onclick = () => {
      totalDeaths = 0;
      totalClears = 0;
      streak = 0;
      startGame("HARD");
  };
  document.getElementById("startPracticeBtn").onclick = () => {
      streak = 0;
      startGame("PRACTICE");
  };

  backToStartBtn.onclick = () => {
      if(timerInterval) clearInterval(timerInterval);
      resetToTitle();
  };
  
  manualStartBtn.onclick = () => finishMemorize();

  document.body.addEventListener('touchmove', function(e) {
      if (e.target.closest('.board')) e.preventDefault();
  }, { passive: false });

  const firstTapHandler = () => {
    playAudio(bgmTitle);
    document.body.removeEventListener('pointerdown', firstTapHandler);
  };
  document.body.addEventListener('pointerdown', firstTapHandler);

})();
</script>
</body>
</html>
